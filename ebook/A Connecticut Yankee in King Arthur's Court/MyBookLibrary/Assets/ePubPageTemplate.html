<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8" />
        <title>[TITLE]</title>
        <style>
            #epub_viewport {
                height: 100vh;
                left: 0;
                position: relative;
                transition: [TRANSITION];
                width: 100vw;
            }

            html, body {
                -ms-touch-action: none;
                -ms-user-select: none;
                background-color: [BACKGROUND_COLOR];
                border-width: 0;
                margin: 0;
                overflow: hidden;
                padding: 0;
            }

            .epub_section {
                -ms-scroll-style: none;
                background-color: [BACKGROUND_COLOR];
                color: [FONT_COLOR];
                column-count: [COLUMN_COUNT];
                column-fill: auto;
                column-gap: 4vw;
                display: none;
                font-family: [FONT_STYLE];
                font-size: [FONT_SIZE]rem;
                height: 100vh;
                line-height: 130%;
                position: absolute;
                text-align: justify;
                width: 100vw;
            }

            .epub_section h1 { line-height: 110% !important; }

            .epub_section img {
                display: block !important;
                margin: 1vw auto 1vw auto !important;
                max-height: 96vh !important;
                max-width: 46vw !important;
            }

            .epub_section p {
                margin-bottom: 7px;
                margin-top: 7px;
            }

            #epub_progressRingWrapper {
                -ms-flex-align: center;
                display: none;
                height: 100vh;
                position: absolute;
                width: 100vw;
                z-index: 10000;
            }

            .epub_opaqueProgressRingWrapper { background-color: [BACKGROUND_COLOR] !important; }

            #epub_progressRing {
                height: 15%;
                margin: auto;
                width: 30%;
            }

            progress:-ms-fill { animation-name: -ms-ring; }
        </style>
    </head>
    <body>
        <div id="epub_progressRingWrapper"><progress id="epub_progressRing"></progress></div>
        <div id="epub_viewport">
            [CONTENT]
        </div>
        <script type="text/javascript">
            var startPage = [START_PAGE];
            var transitionConfig = "[TRANSITION_CONFIG]";
            var transitionON = [TRANSITION_STATUS];
            var sections = document.getElementsByClassName("epub_section");
            epub_viewport.style.left = '0px';
            var currentSection;
            var sectionsInfo = {};
            var parsedSections = {};
            var sectionContentRequestCallbacks = {};
            var currentPage, currentPageWithinSection;
            var pagesPerScreen = sections[0].currentStyle.columnCount * 1;
            var numberOfSections = sections.length;
            var totalNumberOfPages = 0;
            var screenWidth, contentWidth, columnGap, columnWidth;
            var previousSectionDiv;
            var notUserReady, currentProcessingThreadId = 0, latestSectionContentRequestId = 0;
            var hidePreviousSectionDivTimeoutId;
            var Version = 1.0;

            function href_click(e) {
                window.external.notify(e, this);
            }

            function onPointerDown(event) {
                if (!checkIfActionAllowed()) return;
                if ((event.srcElement != null) && (event.srcElement.tagName.toLowerCase() == "a")) return;

                if ((event.pointerType == event.MSPOINTER_TYPE_MOUSE) && (event.buttons != 1)) {
                    return false;
                }

                window.external.notify("pointerdown#" + event.clientX + "#" + event.clientY);
            }

            function onPointerUp(event) {
                if (!checkIfActionAllowed()) return;
                if ((event.srcElement != null) && (event.srcElement.tagName.toLowerCase() == "a")) return;

                window.external.notify("pointerup#" + event.clientX + "#" + event.clientY);
            }

            function onMouseWheel(event) {
                if (!checkIfActionAllowed()) return;

                window.external.notify("mousewheel#" + event.wheelDelta);
            }

            function onSelectStart(event) {
                event.preventDefault();
            }

            function onKeyDown(event) {
                if (!checkIfActionAllowed()) return;

                window.external.notify("keydown#" + event.keyCode);
            }

            function onResize() {
                showProgressBar(true);
                setUserNotReady();

                function checkAndStartSetup() {
                    if (screenWidth == window.screenWidth) {
                        setTimeout(checkAndStartSetup, 20);
                    } else {
                        setupContent();
                    }
                }

                checkAndStartSetup();
            }

            function setUserNotReady() {
                notUserReady = true;
                window.external.notify("userReadyStateChanged#False");
            }

            function setUserReady() {
                notUserReady = false;
                window.external.notify("userReadyStateChanged#True");
            }

            function checkIfActionAllowed() {
                if (notUserReady) {
                    showProgressBar(false);
                    return false;
                }

                return true;
            }

            function showProgressBar(opaque) {
                if (opaque) {
                    epub_progressRingWrapper.className = "epub_opaqueProgressRingWrapper";
                }
                epub_progressRingWrapper.style.display = '-ms-flexbox';
            }

            function hideProgressBar() {
                epub_progressRingWrapper.style.display = 'none';
                epub_progressRingWrapper.className = "";
            }

            function hidePreviousSectionDiv() {
                previousSectionDiv.style.display = 'none';
                hidePreviousSectionDivTimeoutId = null;
            }

            function navigate(fromSection, toSection, newCurrentPageWithinSection) {
                if ((sectionsInfo[toSection] == null) || !parsedSections[toSection]) {
                    if (notUserReady) {
                        return "False";
                    }

                    showProgressBar(true);
                    setUserNotReady();
                    setTimeout(function() {
                        processSection(toSection, function() {
                            navigate(fromSection, toSection, newCurrentPageWithinSection);
                            hideProgressBar();
                            setUserReady();
                        });
                    }, 5);

                    return "True";
                }

                if (typeof(newCurrentPageWithinSection) == "function") {
                    newCurrentPageWithinSection = newCurrentPageWithinSection();
                }

                var toSectionDiv = sections[toSection];
                var pagesToScroll;

                if ((fromSection != null) && (toSection != fromSection)) {
                    var fromSectionDiv = sections[fromSection];
                    var fromSectionLeft = parseFloat(fromSectionDiv.style.left);
                    if (toSection < fromSection) {
                        pagesToScroll = -1 * (currentPageWithinSection + sectionsInfo[toSection].NumberOfPages - newCurrentPageWithinSection);
                        toSectionDiv.style.left = fromSectionLeft - (sectionsInfo[toSection].NumberOfPages * columnWidth) + 'px';
                    } else {
                        pagesToScroll = sectionsInfo[fromSection].NumberOfPages - currentPageWithinSection + newCurrentPageWithinSection;
                        toSectionDiv.style.left = fromSectionLeft + (sectionsInfo[fromSection].NumberOfPages * columnWidth) + 'px';
                    }
                    toSectionDiv.style.display = 'block';
                    if ((previousSectionDiv != null) && (previousSectionDiv != toSectionDiv)) {
                        previousSectionDiv.style.display = 'none';
                    }
                    previousSectionDiv = fromSectionDiv;

                    if (hidePreviousSectionDivTimeoutId != null) {
                        clearTimeout(hidePreviousSectionDivTimeoutId);
                    }
                    hidePreviousSectionDivTimeoutId = setTimeout(hidePreviousSectionDiv, 550);
                } else if (fromSection == null) {
                    pagesToScroll = newCurrentPageWithinSection;
                } else {
                    pagesToScroll = newCurrentPageWithinSection - currentPageWithinSection;
                }

                epub_viewport.style.left = parseFloat(epub_viewport.style.left) - pagesToScroll * columnWidth + 'px';

                return setCurrentPage(toSection, newCurrentPageWithinSection);
            }

            function goToFirstPage() {
                return navigate(currentSection, 0, 0);
            }

            function goToLastPage() {
                return navigate(currentSection, numberOfSections - 1, function() {
                    return (sectionsInfo[numberOfSections - 1].NumberOfPages - pagesPerScreen);
                });
            }

            function goToPrevPage() {
                if ((currentPageWithinSection - pagesPerScreen) >= 0) {
                    return navigate(currentSection, currentSection, currentPageWithinSection - pagesPerScreen);
                } else if (currentSection > 0) {
                    return navigate(currentSection, currentSection - 1, function() {
                        return (sectionsInfo[currentSection - 1].NumberOfPages - pagesPerScreen);
                    });
                } else {
                    return "False";
                }
            }

            function goToNextPage() {
                if ((currentPageWithinSection + pagesPerScreen) < sectionsInfo[currentSection].NumberOfPages) {
                    return navigate(currentSection, currentSection, currentPageWithinSection + pagesPerScreen);
                } else if ((currentSection + 1) < numberOfSections) {
                    return navigate(currentSection, currentSection + 1, 0);
                } else {
                    return "False";
                }
            }

            function goToPage(page) {
                page = page * 1;
                if ((page % pagesPerScreen) != 0) {
                    page = Math.floor(page / pagesPerScreen) * pagesPerScreen;
                }

                for (var index = 0; index < numberOfSections; index++) {
                    if (sectionsInfo[index] == null) {
                        return;
                    }

                    if ((page >= sectionsInfo[index].StartPage) &&
                        (page < (sectionsInfo[index].StartPage + sectionsInfo[index].NumberOfPages))) {
                        return navigate(currentSection, index, page - sectionsInfo[index].StartPage);
                    }
                }
            }

            function goToSection(section) {
                section = section * 1;
                return navigate(currentSection, section, 0);
            }

            function getTOCInfo() {
                var section;
                var tocSections = currentSection + "#";
                for (var index = 0; index < numberOfSections; index++) {
                    section = sections[index];
                    if ((section.attributes["InTOC"] != null) && (section.getAttribute("InTOC").toString() == "True")) {
                        tocSections += (index + '#');
                    }
                }

                return tocSections.substring(0, tocSections.length - 1);
            }

            function changeFontSize(fontSize) {
                showProgressBar(true);
                setUserNotReady();

                setTimeout(function() {
                    var sectionClass = document.styleSheets[0].rules[3];
                    sectionClass.style.fontSize = fontSize + 'rem';
                    setupContent();
                }, 20);
            }

            function changeFontStyle(fontStyle) {
                showProgressBar(true);
                setUserNotReady();

                setTimeout(function() {
                    var sectionClass = document.styleSheets[0].rules[3];
                    sectionClass.style.fontFamily = fontStyle;
                    setupContent();
                }, 20);
            }

            function sectionContentReceived(index, content, sectionContentRequestId) {
                sections[index].innerHTML = content;
                parsedSections[index] = true;

                if (sectionContentRequestCallbacks[sectionContentRequestId] == null) {
                    return;
                }

                if (sectionsInfo[index] == null) {
                    processSection_Impl(index, sectionContentRequestCallbacks[sectionContentRequestId]);
                } else {
                    if (index == currentSection) {
                        sections[index].style.display = 'block';
                    }
                    sectionContentRequestCallbacks[sectionContentRequestId]();
                }

                delete sectionContentRequestCallbacks[sectionContentRequestId];
            }

            function changeColorTheme(backgroundColor, textColor) {
                var htmlClass = document.styleSheets[0].rules[1];
                htmlClass.style.backgroundColor = backgroundColor;

                var sectionClass = document.styleSheets[0].rules[3];
                sectionClass.style.backgroundColor = backgroundColor;
                sectionClass.style.color = textColor;

                var progressRingWrapperClass = document.styleSheets[0].rules[8];
                progressRingWrapperClass.style.backgroundColor = backgroundColor + " !important";
            }

            function toggleSlideAnimation(slideOn) {
                var sectionClass = document.styleSheets[0].rules[0];
                if (slideOn == "True") {
                    sectionClass.style.transition = transitionConfig;
                    transitionON = true;
                } else {
                    sectionClass.style.transition = "initial";
                    transitionON = false;
                }
            }

            function changeOrientation(numberOfColumns) {
                window.removeEventListener("resize", onResize);

                if (screenWidth == window.innerWidth) {
                    setTimeout(function() {
                        changeOrientation(numberOfColumns);
                    }, 20);
                    return;
                }

                showProgressBar(true);
                setUserNotReady();

                setTimeout(function() {
                    var currentPagesPerScreen = document.styleSheets[0].rules[3].style.columnCount * 1;
                    if ((numberOfColumns * 1) != currentPagesPerScreen) {
                        pagesPerScreen = numberOfColumns * 1;
                        document.styleSheets[0].rules[3].style.columnCount = pagesPerScreen;
                    }

                    setupContent(function() {
                        window.addEventListener("resize", onResize);
                        window.external.notify("numberOfColumnsChanged#" + currentPage);
                    });
                }, 20);
            }

            function changeNumberOfColumns(numberOfColumns) {
                showProgressBar(true);
                setUserNotReady();

                setTimeout(function() {
                    var currentPagesPerScreen = document.styleSheets[0].rules[3].style.columnCount * 1;
                    if ((numberOfColumns * 1) != currentPagesPerScreen) {
                        pagesPerScreen = numberOfColumns * 1;
                        document.styleSheets[0].rules[3].style.columnCount = pagesPerScreen;
                    }

                    setupContent(function() {
                        window.external.notify("numberOfColumnsChanged#" + currentPage);
                    });
                }, 20);
            }

            function setCurrentPage(section, pageWithinSection) {
                if ((currentSection != section) || (currentPageWithinSection != pageWithinSection)) {
                    currentSection = section;
                    currentPageWithinSection = pageWithinSection;

                    if (totalNumberOfPages != 0) {
                        currentPage = sectionsInfo[section].StartPage + pageWithinSection;
                        window.external.notify("currentPage#" + currentPage + "#" + currentSection +
                            "#" + currentPageWithinSection + "#" + sectionsInfo[currentSection].NumberOfPages +
                            "#" + totalNumberOfPages);
                    }

                    return "True";
                } else {
                    return "False";
                }
            }

            function handleExternalRef(link) {
                window.external.notify("navigateToExternalPage#" + link);
            }

            function handleInternalRef(sectionIndex) {
                goToSection(sectionIndex);
            }

            function handleInternalTOCRef(tocId, section) {
                searchLocation(tocId, section);
            }

            function searchLocation(tocId, section, waitingForContent) {
                if (section == null) {
                    section = currentSection;
                }

                if (!parsedSections[section]) {
                    showProgressBar(true);
                    setUserNotReady();
                    setTimeout(function() {
                        processSection(section, function() {
                            searchLocation(tocId, section, true);
                        });
                    }, 5);
                    return;
                }

                var targetElement;
                var sectionDiv = sections[section];
                var elementsInSection = sectionDiv.querySelectorAll("*|*[id='" + tocId + "'");
                if (elementsInSection.length == 0) {

                    elementsInSection = sectionDiv.querySelectorAll("*|*[name='" + tocId + "'");
                    if (elementsInSection.length > 0) {
                        targetElement = elementsInSection[0];
                    }
                } else {
                    targetElement = elementsInSection[0];
                }

                if (targetElement != null) {
                    navigateToElement(targetElement, waitingForContent);
                } else {
                    window.external.notify("locationNotFound");
                }
            }

            function navigateToElement(element, waitingForContent) {
                if (waitingForContent) {
                    setUserReady();
                    hideProgressBar();
                }

                var parentNode = element.parentNode;
                while (parentNode != null) {
                    if (parentNode.className == "epub_section") {

                        for (var index = 0; index < numberOfSections; index++) {
                            if (sections[index] == parentNode) {
                                sections[index].style.display = 'block';
                                var offset = element.offsetLeft + 5;
                                var page = Math.floor(offset * 1.0 / columnWidth);
                                navigate(currentSection, index, page);
                                break;
                            }
                        }
                        break;
                    }
                    parentNode = parentNode.parentNode;
                }
            }

            function computeNewCurrentPage(currentPageWithinSection, currentSection, pagesInCurrentSection) {
                if (currentPageWithinSection == 0) {
                    navigate(null, currentSection, 0);
                } else {
                    var diff = sectionsInfo[currentSection].NumberOfPages / (pagesInCurrentSection * 1.0);
                    var newPage = Math.floor(currentPageWithinSection * diff / pagesPerScreen) * pagesPerScreen;
                    if (newPage > sectionsInfo[currentSection].NumberOfPages) {
                        newPage = sectionsInfo[currentSection].NumberOfPages - pagesPerScreen;
                    }
                    navigate(null, currentSection, newPage);
                }
            }

            function processSection_Impl(index, callback) {
                var hideBack = (index != currentSection);
                var section = sections[index];

                if (section.style.display != 'block') {
                    section.style.display = 'block';
                }

                var sectionWidth = section.scrollWidth;
                var sectionPages = Math.floor((sectionWidth + columnGap) / columnWidth + 0.2);
                sectionPages = Math.ceil(sectionPages / pagesPerScreen) * pagesPerScreen;

                if (hideBack) {
                    section.style.display = 'none';
                }

                sectionsInfo[index] = {
                    NumberOfPages: sectionPages,
                    SectionWidth: sectionWidth
                };
                callback();
            }

            function processSection(index, callback) {

                if (!parsedSections[index]) {
                    latestSectionContentRequestId++;
                    sectionContentRequestCallbacks[latestSectionContentRequestId] = callback;
                    window.external.notify("getSectionContent#" + index + "#" + latestSectionContentRequestId);
                    return;
                }

                if (sectionsInfo[index] == null) {
                    processSection_Impl(index, callback);
                } else {
                    if (index == currentSection) {
                        sections[index].style.display = 'block';
                    }
                    callback();
                }
            }

            function processSections(index, processingThreadId, callback) {
                if (currentProcessingThreadId != processingThreadId) {

                    return;
                }

                processSection(index, function() {
                    if (index < (numberOfSections - 1)) {
                        setTimeout(
                            function() {
                                processSections(index + 1, processingThreadId, callback);
                            }, 5);
                        return;
                    }

                    if (index == (numberOfSections - 1)) {
                        callback();
                    }
                });
            }

            function serializeDeviceInfo() {
                return JSON.stringify({
                    ScreenWidth: screenWidth,
                    ScreenHeight: window.innerHeight,
                    NumberOfColumns: pagesPerScreen,
                    DeviceXDPI: window.screen.deviceXDPI,
                    DeviceYDPI: window.screen.deviceYDPI,
                    LogicalXDPI: window.screen.logicalXDPI,
                    LogicalYDPI: window.screen.logicalYDPI,
                    SystemXDPI: window.screen.systemXDPI,
                    SystemYDPI: window.screen.systemYDPI
                });
            }

            function setTransitionOff() {
                if (transitionON) {
                    var sectionClass = document.styleSheets[0].rules[0];
                    sectionClass.style.transition = "initial";
                }
            }

            function setTransitionOn() {
                if (transitionON) {
                    var sectionClass = document.styleSheets[0].rules[0];
                    sectionClass.style.transition = transitionConfig;
                }
            }

            function getSectionsInfo() {
                window.external.notify("getSectionsInfo#" + serializeDeviceInfo() + "#" + Version);
            }

            function sectionsInfoReceived(sectionsInfoAvailable, sectionsInfoStr) {
                sectionsInfoAvailable = (sectionsInfoAvailable == "true") ? true : false;
                if (sectionsInfoAvailable) {
                    sectionsInfo = JSON.parse(sectionsInfoStr);
                }

                if (startPage != null) {
                    currentSection = startPage.CurrentSection;
                    processSection(startPage.CurrentSection, sectionsInfoAvailable ?
                        function() { setup_Cont(true); } : setup_Cont);
                } else {
                    currentSection = 0;
                    processSection(0, sectionsInfoAvailable ?
                        function() { setup_Cont(true); } : setup_Cont);
                }
            }

            function setupContent(callback) {
                screenWidth = window.innerWidth;

                startPage = {
                    CurrentSection: currentSection,
                    CurrentPageInSection: currentPageWithinSection,
                    PagesInSection: sectionsInfo[currentSection].NumberOfPages
                };

                setTransitionOff();

                epub_viewport.style.left = "0px";
                sections[currentSection].style.left = "0px";

                window.external.notify("backgroundProcessing");
                totalNumberOfPages = 0;
                currentSection = currentPageWithinSection = null;
                currentProcessingThreadId++;
                sectionsInfo = {};
                sectionContentRequestCallbacks = {};
                if (previousSectionDiv != null) {
                    previousSectionDiv.style.display = 'none';
                }

                setup(callback);

                setTimeout(setTransitionOn, 5);
            }

            function calculatePages() {
                for (var i = 0; i < numberOfSections; i++) {
                    sectionsInfo[i].StartPage = totalNumberOfPages;
                    totalNumberOfPages += sectionsInfo[i].NumberOfPages;
                }

                currentPage = sectionsInfo[currentSection].StartPage + currentPageWithinSection;
                window.external.notify("numberOfPages#" + totalNumberOfPages);
                window.external.notify("currentPage#" + currentPage + "#" + currentSection +
                    "#" + currentPageWithinSection + "#" + sectionsInfo[currentSection].NumberOfPages +
                    "#" + totalNumberOfPages);
            }

            function onFinish() {
                if (totalNumberOfPages == 0) {
                    calculatePages();
                }

                window.external.notify("sectionsInfo#" + JSON.stringify(sectionsInfo) + "#" +
                    serializeDeviceInfo() + "#" + Version);

                sections[startPage == null ? 0 : startPage.CurrentSection].style.zIndex = '';

                if (getSectionsInfoCallback != null) {
                    getSectionsInfoCallback();
                    getSectionsInfoCallback = null;
                }
            }

            function setup(callback) {
                sections[startPage == null ? 0 : startPage.CurrentSection].style.zIndex = 1000;
                sections[startPage == null ? 0 : startPage.CurrentSection].style.left = '0px';

                columnGap = parseFloat(sections[0].currentStyle.columnGap) / 100 * screenWidth;
                columnWidth = (screenWidth + columnGap) / pagesPerScreen;

                getSectionsInfoCallback = callback;
                getSectionsInfo();
            }

            function setup_Cont(sectionsInfoAvailable) {
                setTransitionOff();

                if (startPage != null) {
                    computeNewCurrentPage(startPage.CurrentPageInSection, startPage.CurrentSection,
                        startPage.PagesInSection);
                } else {
                    computeNewCurrentPage(0, 0);
                }

                window.addEventListener("resize", onResize);
                window.external.notify("pageReady");

                setUserReady();
                hideProgressBar();

                setTimeout(function() {
                    setTransitionOn();
                    if (sectionsInfoAvailable) {
                        calculatePages();
                    }
                    processSections(0, currentProcessingThreadId, onFinish);
                }, 5);
            }

            function start() {
                document.addEventListener("MSPointerDown", onPointerDown);
                document.addEventListener("MSPointerUp", onPointerUp);
                document.addEventListener("mousewheel", onMouseWheel);
                document.addEventListener("keydown", onKeyDown);
                document.body.addEventListener('selectstart', onSelectStart, false);
                showProgressBar(true);
                setUserNotReady();

                function waitForPageToBeReady() {
                    screenWidth = window.innerWidth;

                    if (screenWidth < 10) {
                        setTimeout(function() {
                            waitForPageToBeReady();
                        }, 25);

                        return;
                    }
                    setup();
                }

                setTimeout(waitForPageToBeReady, 5);
            }

            start();
        </script>
    </body>
</html>